<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="color-scheme" content="light dark" />
  <title>Typing Practice · 单文件版</title>
  <style>
    :root{
      --bg1:#f0f7ff; --bg2:#fafafa; --fg:#0b0f19; --card:#ffffffcc; --muted:#6b7280; --ok:#047857; --err:#b91c1c;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg1:#0b0f19; --bg2:#0b0f19; --fg:#e5e7eb; --card:#111827e6; --muted:#9ca3af; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.6 ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;color:var(--fg);background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    .container{max-width:900px;margin:0 auto;padding:24px}
    .row{display:flex;gap:12px;align-items:center}
    .card{background:var(--card);backdrop-filter:saturate(1.2) blur(2px);box-shadow:0 6px 20px rgba(0,0,0,.08);border-radius:16px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #0001;background:#fff8;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    @media(prefers-color-scheme:dark){.btn{background:#1f2937;color:#e5e7eb;border-color:#fff1}}

    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}

    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .stat{padding:12px}
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-weight:700;font-size:20px}

    .prompt{padding:16px 18px;font-size:18px;line-height:1.9}
    .green{color:var(--ok)}
    .red{color:var(--err);background:rgba(185,28,28,.06)}
    .caret{display:inline-block;width:2px;height:20px;background:currentColor;vertical-align:-3px;animation:blink 1s steps(1) infinite}
    @keyframes blink{50%{opacity:0}}

    .input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #0001;background:#fff}
    @media(prefers-color-scheme:dark){.input{background:#111827;color:#e5e7eb;border-color:#fff1}}

    textarea{width:100%;min-height:140px;padding:12px;border-radius:12px;border:1px solid #0001;background:#fff}
    @media(prefers-color-scheme:dark){textarea{background:#111827;color:#e5e7eb;border-color:#fff1}}

    .footer{font-size:12px;color:var(--muted);padding-top:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between;margin-bottom:12px">
      <h1>打字练习 · Typing Practice</h1>
      <div class="row">
        <button id="langBtn" class="btn">中文</button>
        <button id="customBtn" class="btn">自定义</button>
      </div>
    </div>

    <section class="stats">
      <div class="card stat"><div class="k">用时</div><div class="v" id="tTime">00:00</div></div>
      <div class="card stat"><div class="k">CPM</div><div class="v" id="tCPM">0</div></div>
      <div class="card stat"><div class="k">WPM</div><div class="v" id="tWPM">0</div></div>
      <div class="card stat"><div class="k">准确率</div><div class="v" id="tACC">100%</div></div>
    </section>

    <section id="promptCard" class="card prompt" style="margin-top:14px"></section>

    <div class="row" style="margin-top:12px">
      <input id="input" autocomplete="off" class="input" placeholder="在这里输入上面的句子，然后回车或继续输入……" />
    </div>

    <div class="row" style="margin-top:12px">
      <button id="resetBtn" class="btn">重新开始</button>
      <button id="nextBtn" class="btn">下一句</button>
      <div style="margin-left:auto" class="muted">历史最佳 WPM：<b id="best">0</b></div>
    </div>

    <section id="customPanel" class="card" style="display:none;margin-top:14px;padding:12px">
      <div class="muted" style="margin-bottom:8px">自定义句库（每行一条），会覆盖当前语言的内置句子。</div>
      <textarea id="customTA" placeholder="每行一条练习句子\n例如：\n保持放松，先求准确，再逐步提速。\nTyping is a rhythm, not a race."></textarea>
      <div class="row" style="margin-top:10px">
        <button id="importBtn" class="btn">导入</button>
        <button id="cancelBtn" class="btn">取消</button>
      </div>
    </section>

    <div class="footer">
      Tips：先保证准确率，再逐步提升速度。建议每日 10~15 分钟高质量练习。<br/>
      PWA：本页在支持的浏览器/域名下可“添加到主屏幕”。如需完全离线，请将本文件部署到 https:// 或 localhost 以启用 Service Worker。
    </div>
  </div>

  <script>
    const CN = [
      "保持放松，先求准确，再逐步提速。",
      "专注十分钟的高质量练习，胜过漫长而松散的练习。",
      "今天的速度不重要，重要的是可持续的进步。",
      "姿势端正，手腕放松，目光看屏幕，轻敲键盘。",
      "打字如写作：清晰与节奏比炫技更重要。",
      "错误并不可怕，及时纠正与复盘才是关键。",
      "熟能生巧，坚持就会看到改变。",
    ];
    const EN = [
      "The quick brown fox jumps over the lazy dog.",
      "Practice makes progress, not perfection.",
      "Type with relaxed shoulders and steady rhythm.",
      "Measure what matters: accuracy first, then speed.",
      "Small, consistent sessions compound into mastery.",
      "Good posture reduces fatigue and improves control.",
    ];

    const $ = sel => document.querySelector(sel);
    const promptCard = $('#promptCard');
    const input = $('#input');
    const tTime = $('#tTime');
    const tCPM = $('#tCPM');
    const tWPM = $('#tWPM');
    const tACC = $('#tACC');
    const bestEl = $('#best');

    const langBtn = $('#langBtn');
    const customBtn = $('#customBtn');
    const customPanel = $('#customPanel');
    const importBtn = $('#importBtn');
    const cancelBtn = $('#cancelBtn');
    const customTA = $('#customTA');
    const resetBtn = $('#resetBtn');
    const nextBtn = $('#nextBtn');

    const BEST_KEY = 'typing.best.wpm';
    const LANG_KEY = 'typing.lang';

    let lang = localStorage.getItem(LANG_KEY) || 'CN';
    let pool = lang==='CN'? CN : EN;
    let idx = 0;
    let prompt = pool[idx];
    let typed = '';
    let startAt = null; // ms timestamp
    let now = Date.now();
    let tickId = null;

    function loadBest(){ return Number(localStorage.getItem(BEST_KEY) || 0); }
    function saveBest(v){ localStorage.setItem(BEST_KEY, String(Math.round(v))); bestEl.textContent = Math.round(v); }

    function pad2(n){ return String(n).padStart(2,'0'); }

    function formatTime(ms){ const s = Math.floor(ms/1000); return pad2(Math.floor(s/60))+':'+pad2(s%60); }

    function render(){
      // render highlighted prompt vs typed
      promptCard.replaceChildren();
      const n = Math.max(prompt.length, typed.length);
      for(let i=0;i<n;i++){
        const p = prompt[i] || '';
        const t = typed[i] || '';
        const span = document.createElement('span');
        if(!t){ span.className = 'muted'; span.textContent = p || '□'; }
        else if(t===p){ span.className = 'green'; span.textContent = p; }
        else { span.className = 'red'; span.textContent = p || '□'; }
        promptCard.appendChild(span);
      }
      // caret
      const caret = document.createElement('span');
      caret.className = 'caret';
      promptCard.appendChild(caret);

      // stats
      const elapsed = startAt? Math.max(1, now - startAt) : 1;
      const minutes = elapsed / 60000;
      const chars = typed.length;
      const correct = [...typed].filter((c,i)=> c===prompt[i]).length;
      const cpm = chars>0? chars/minutes : 0;
      const wpm = cpm/5;
      const acc = chars>0? 100*correct/Math.max(1, chars) : 100;

      tTime.textContent = formatTime(elapsed);
      tCPM.textContent = String(Math.round(cpm));
      tWPM.textContent = String(Math.round(wpm));
      tACC.textContent = Math.round(acc)+'%';

      const best = loadBest();
      if(wpm>best) saveBest(wpm);
    }

    function reset(){ typed=''; startAt=null; now=Date.now(); input.value=''; render(); input.focus(); }
    function next(){ idx++; prompt = pool[idx % pool.length]; reset(); }
    function importCustom(text){
      const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      if(lines.length){ pool = lines; idx=0; prompt = pool[0]; reset(); }
    }

    // events
    input.addEventListener('input', (e)=>{
      typed = input.value;
      if(!startAt && typed.length>0) startAt = Date.now();
      render();
    });
    resetBtn.addEventListener('click', reset);
    nextBtn.addEventListener('click', next);

    langBtn.addEventListener('click', ()=>{
      lang = (lang==='CN')? 'EN':'CN';
      localStorage.setItem(LANG_KEY, lang);
      pool = lang==='CN'? CN : EN;
      langBtn.textContent = (lang==='CN'? '中文':'EN');
      idx=0; prompt = pool[0]; reset();
    });

    customBtn.addEventListener('click', ()=>{ customPanel.style.display = 'block'; });
    cancelBtn.addEventListener('click', ()=>{ customPanel.style.display = 'none'; });
    importBtn.addEventListener('click', ()=>{ importCustom(customTA.value); customPanel.style.display='none'; });

    // ticker
    tickId = setInterval(()=>{ if(startAt) { now = Date.now(); render(); } }, 200);

    // init
    bestEl.textContent = loadBest();
    langBtn.textContent = (lang==='CN'? '中文':'EN');
    render();
    input.focus();

    // --- PWA bits: create manifest + service worker from in-memory blobs ---
    (function setupPWA(){
      // dynamic manifest (optional)
      try{
        const manifest = {name:'Typing Practice', short_name:'Typing', start_url:'.', display:'standalone', theme_color:'#0ea5e9', background_color:'#0b0f19', icons:[]};
        const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
      }catch(e){}

      // service worker (requires https or localhost)
      if('serviceWorker' in navigator){
        const sw = `
          const CACHE='typing-cache-v1';
          self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=> c.addAll([self.registration.scope]))); });
          self.addEventListener('fetch', e=>{ e.respondWith(fetch(e.request).catch(()=> caches.match(self.registration.scope))); });
        `;
        const blob = new Blob([sw], {type:'text/javascript'});
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url).catch(()=>{});
      }
    })();
  </script>
</body>
</html>
